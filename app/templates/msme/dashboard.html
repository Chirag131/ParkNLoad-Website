{% extends "base.html" %}

{% block title %}MSME Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo-section">
                <div class="logo-icon">
                    <img src="{{ url_for('static', filename='assets/logo.png') }}" alt="">
                </div>
                <div class="brand-name">ParkNload</div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="{{ url_for('msme.dashboard') }}" class="nav-link active" onclick="setActive(this)">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('msme.orders') }}" class="nav-link" onclick="setActive(this)">Orders</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="setActive(this)">Inventory</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="setActive(this)">Analysis</a>
                </li>
            </ul>
            
            <div class="user-section">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
                <button class="profile-btn">{{ current_user.name[0] }}</button>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
    <div class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-header">
            <div class="logo-section">
                <div class="logo-icon">P</div>
                <div class="brand-name">ParkNload</div>
            </div>
            <button class="mobile-close" onclick="closeMobileMenu()">‚úï</button>
        </div>
        <ul class="mobile-nav-menu">
            <li class="mobile-nav-item">
                <a href="{{ url_for('msme.dashboard') }}" class="mobile-nav-link active" onclick="setMobileActive(this)">Dashboard</a>
            </li>
            <li class="mobile-nav-item">
                <a href="{{ url_for('msme.add_order') }}" class="mobile-nav-link" onclick="setMobileActive(this)">Add Delivery</a>
            </li>
            <li class="mobile-nav-item">
                <a href="{{ url_for('msme.warehouses') }}" class="mobile-nav-link" onclick="setMobileActive(this)">Warehouse Management</a>
            </li>
            <li class="mobile-nav-item">
                <a href="#" class="mobile-nav-link" onclick="setMobileActive(this)">Inventory</a>
            </li>
            <li class="mobile-nav-item">
                <a href="#" class="mobile-nav-link" onclick="setMobileActive(this)">Inventory Forecasting</a>
            </li>
        </ul>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-container">
        <!-- Welcome Section with Workspace Dropdown -->
        <div class="welcome-section">
            <div class="welcome-title">Welcome {{ current_user.name }}!</div>
            <div class="workspace-section">
                <div class="workspace-dropdown">
                    <div class="workspace-selector" id="workspaceSelector" onclick="toggleWorkspace()">
                        <span id="selectedWorkspace">
                            {% if current_warehouse %}
                                {{ current_warehouse.name }}
                            {% else %}
                                Select Workspace
                            {% endif %}
                        </span>
                        <span class="dropdown-arrow" id="dropdownArrow">‚ñº</span>
                    </div>
                    {% if user_warehouses %}
                    <div class="workspace-options" id="workspaceOptions" style="display: none;">
                        {% for warehouse in user_warehouses %}
                        <div class="workspace-option" onclick="selectWorkspace('{{ warehouse.id }}', '{{ warehouse.name }}')">
                            {{ warehouse.name }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card" onclick="animateCard(this)">
                <div class="stat-value">{{ incoming_orders }}</div>
                <div class="stat-label">Incoming Orders</div>
            </div>
            <div class="stat-card" onclick="animateCard(this)">
                <div class="stat-value">{{ outgoing_orders }}</div>
                <div class="stat-label">Outgoing Shipments</div>
            </div>
            <div class="stat-card" onclick="animateCard(this)">
                <div class="stat-value">{{ warehouse_count }}</div>
                <div class="stat-label">Warehouses</div>
            </div>
            <div class="stat-card" onclick="animateCard(this)">
                <div class="stat-value">{{ incoming_orders + outgoing_orders }}</div>
                <div class="stat-label">Total Orders</div>
            </div>
        </div>

        <!-- Main Layout with Map and Upcoming Deliveries -->
        <div class="main-layout">
            <!-- Map Container -->
            <div class="map-container">
                <div class="map-header">
                    <div class="map-title">Live Tracking Map</div>
                    <div class="map-controls">
                        <button class="map-btn" onclick="refreshMap()">Refresh</button>
                        <button class="map-btn" onclick="openFullMap()">Full View</button>
                    </div>
                </div>
                <div class="map-display" onclick="openFullMap()">
                    <div class="map-icon">üó∫Ô∏è</div>
                    <div class="map-text">Click to view interactive map</div>
                </div>
            </div>

            <!-- Upcoming Deliveries -->
            <div class="upcoming-deliveries">
                <div class="upcoming-title">
                    Upcoming Deliveries
                </div>
                {% if recent_orders %}
                    {% for order in recent_orders[:5] %}
                    <div class="upcoming-item">
                        <div class="delivery-id">DEL-{{ order.id }}</div>
                        <div class="delivery-time">Expected: {{ order.time_slot }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="upcoming-item">
                        <div class="delivery-id">No upcoming deliveries</div>
                        <div class="delivery-time">Create your first order</div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Active Deliveries Table -->
        <div class="active-deliveries">
            <div class="table-header">
                <div class="table-title">Active Deliveries</div>
                <button class="add-delivery-btn" onclick="addNewDelivery()">+ Add New Delivery</button>
            </div>
            
            <div class="table-scroll">
                <table class="deliveries-table">
                    <thead>
                        <tr>
                            <th>Vehicle ID</th>
                            <th>Logistics Company</th>
                            <th>Route/Type</th>
                            <th>Supplier</th>
                            <th>Status</th>
                            <th>ETA</th>
                            <th>Priority</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_orders %}
                            {% for order in recent_orders[:6] %}
                            <tr>
                                <td class="delivery-row-id">DEL-{{ order.id }}</td>
                                <td>
                                    <div class="company-name">{{ order.logistic_company }}</div>
                                    <div class="delivery-info">
                                        {% if order.driver %}
                                            Driver: {{ order.driver.name }}
                                        {% else %}
                                            Driver: Not assigned
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="company-name">
                                        {% if order.order_type == 'incoming' %}
                                            üîÑ Incoming
                                        {% else %}
                                            üì§ Outgoing
                                        {% endif %}
                                    </div>
                                    <div class="delivery-info">{{ order.package_type|title }}</div>
                                </td>
                                <td>
                                    <div class="company-name">
                                        {% if order.supplier_name %}
                                            {{ order.supplier_name }}
                                        {% else %}
                                            {{ current_user.name }}
                                        {% endif %}
                                    </div>
                                    <div class="delivery-info">
                                        {% if order.supplier_phone %}
                                            Contact: {{ order.supplier_phone }}
                                        {% else %}
                                            Contact: N/A
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="status-badge status-pending">
                                        {% if order.order_type == 'incoming' %}
                                            Incoming
                                        {% else %}
                                            Outgoing
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="company-name">{{ order.time_slot }}</div>
                                    <div class="delivery-info">{{ order.date.strftime('%d-%m-%Y') }}</div>
                                </td>
                                <td>
                                    <div class="company-name" style="color: 
                                        {% if order.package_priority == 'high' %}#f59e0b
                                        {% elif order.package_priority == 'medium' %}#8b5cf6
                                        {% else %}#14b8a6{% endif %}">
                                        {{ order.package_priority|title }}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px;">
                                    <div class="empty-state">
                                        <h3>No Orders Yet</h3>
                                        <p>You haven't created any orders yet. Create your first order to get started.</p>
                                        <a href="{{ url_for('msme.add_order') }}" class="btn btn-primary">Create Your First Order</a>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Additional Jinja-specific JavaScript -->
    <script>
        // Function to select warehouse
        function selectWorkspace(warehouseId, warehouseName) {
            // Update the display
            document.getElementById('selectedWorkspace').textContent = warehouseName;
            
            // Hide the options
            document.getElementById('workspaceOptions').style.display = 'none';
            
            // Update the arrow
            document.getElementById('dropdownArrow').textContent = '‚ñº';
            
            // Redirect to set the warehouse
            window.location.href = "{{ url_for('msme.set_warehouse', warehouse_id=0) }}".replace('0', warehouseId);
        }

        // Function to add new delivery
        function addNewDelivery() {
            window.location.href = "{{ url_for('msme.add_order') }}";
        }

        // Function to refresh map
        function refreshMap() {
            // Add map refresh logic here
            console.log('Refreshing map...');
        }

        // Function to open full map
        function openFullMap() {
            // Add full map logic here
            console.log('Opening full map...');
        }

        // Function to animate card
        function animateCard(card) {
            card.style.transform = 'scale(1.05)';
            setTimeout(() => {
                card.style.transform = 'scale(1)';
            }, 200);
        }
    </script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
