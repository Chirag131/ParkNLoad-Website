{% extends "base.html" %}

{% block title %}My Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h2>My Profile</h2>
            <div class="header-actions">
                <a href="{{ url_for('msme.dashboard') }}" class="btn btn-outline">← Back to Dashboard</a>
            </div>
        </div>
    </div>

    <!-- Profile Overview Card -->
    <div class="profile-overview">
        <div class="profile-avatar">
            <div class="avatar-placeholder">
                {{ current_user.name[0].upper() }}
            </div>
            <div class="avatar-actions">
                <button class="btn btn-sm btn-outline" onclick="changeAvatar()">Change Photo</button>
            </div>
        </div>
        <div class="profile-info">
            <h3>{{ current_user.name }}</h3>
            <p class="user-email">{{ current_user.email }}</p>
            <div class="profile-stats">
                <div class="stat-item">
                    <span class="stat-number">{{ current_user.warehouses|length }}</span>
                    <span class="stat-label">Warehouses</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ current_user.orders|length }}</span>
                    <span class="stat-label">Orders</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ current_user.subscription_plan|title }}</span>
                    <span class="stat-label">Plan</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Cards Grid -->
    <div class="profile-cards-grid">
        <!-- Personal Information Card -->
        <div class="profile-card" id="personalInfoCard">
            <div class="card-header">
                <h4>Personal Information</h4>
                <button class="btn btn-sm btn-outline" onclick="toggleEdit('personalInfo')">
                    <span class="edit-icon">✏️</span> Edit
                </button>
            </div>
            <div class="card-content">
                <form id="personalInfoForm" class="edit-form" method="POST" action="{{ url_for('msme.update_profile') }}">
                    <input type="hidden" name="form_type" value="personal">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" name="name" value="{{ current_user.name }}" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" value="{{ current_user.email }}" class="form-control" readonly>
                        <small class="form-text">Email cannot be changed</small>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" name="phone" value="{{ current_user.phone or '' }}" class="form-control" pattern="[0-9]{10}" placeholder="Enter 10-digit phone number">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-outline" onclick="cancelEdit('personalInfo')">Cancel</button>
                    </div>
                </form>
                <div class="display-content" id="personalInfoDisplay">
                    <div class="info-item" data-field="name">
                        <span class="info-label">Full Name:</span>
                        <span class="info-value">{{ current_user.name }}</span>
                    </div>
                    <div class="info-item" data-field="email">
                        <span class="info-label">Email:</span>
                        <span class="info-value">{{ current_user.email }}</span>
                    </div>
                    <div class="info-item" data-field="phone">
                        <span class="info-label">Phone:</span>
                        <span class="info-value">{{ current_user.phone or 'Not provided' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Company Information Card -->
        <div class="profile-card" id="companyInfoCard">
            <div class="card-header">
                <h4>Company Information</h4>
                <button class="btn btn-sm btn-outline" onclick="toggleEdit('companyInfo')">
                    <span class="edit-icon">✏️</span> Edit
                </button>
            </div>
            <div class="card-content">
                <form id="companyInfoForm" class="edit-form" method="POST" action="{{ url_for('msme.update_profile') }}">
                    <input type="hidden" name="form_type" value="company">
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" name="company_name" value="{{ current_user.company_name or '' }}" class="form-control" placeholder="Enter company name">
                    </div>
                    <div class="form-group">
                        <label>Business Address</label>
                        <textarea name="business_address" class="form-control" rows="3" placeholder="Enter business address">{{ current_user.business_address or '' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label>GST Number</label>
                        <input type="text" name="gst_number" value="{{ current_user.gst_number or '' }}" class="form-control" placeholder="Enter GST number">
                    </div>
                    <div class="form-group">
                        <label>PAN Number</label>
                        <input type="text" name="pan_number" value="{{ current_user.pan_number or '' }}" class="form-control" placeholder="Enter PAN number">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-outline" onclick="cancelEdit('companyInfo')">Cancel</button>
                    </div>
                </form>
                <div class="display-content" id="companyInfoDisplay">
                    <div class="info-item" data-field="company_name">
                        <span class="info-label">Company Name:</span>
                        <span class="info-value">{{ current_user.company_name or 'Not provided' }}</span>
                    </div>
                    <div class="info-item" data-field="business_address">
                        <span class="info-label">Business Address:</span>
                        <span class="info-value">{{ current_user.business_address or 'Not provided' }}</span>
                    </div>
                    <div class="info-item" data-field="gst_number">
                        <span class="info-label">GST Number:</span>
                        <span class="info-value">{{ current_user.gst_number or 'Not provided' }}</span>
                    </div>
                    <div class="info-item" data-field="pan_number">
                        <span class="info-label">PAN Number:</span>
                        <span class="info-value">{{ current_user.pan_number or 'Not provided' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription & Billing Card -->
        <div class="profile-card" id="subscriptionCard">
            <div class="card-header">
                <h4>Subscription & Billing</h4>
                <button class="btn btn-sm btn-outline" onclick="toggleEdit('subscription')">
                    <span class="edit-icon">✏️</span> Edit
                </button>
            </div>
            <div class="card-content">
                <form id="subscriptionForm" class="edit-form" method="POST" action="{{ url_for('msme.update_profile') }}">
                    <input type="hidden" name="form_type" value="subscription">
                    <div class="form-group">
                        <label>Current Plan</label>
                        <select name="subscription_plan" class="form-control">
                            <option value="free" {{ 'selected' if current_user.subscription_plan == 'free' }}>Free Plan</option>
                            <option value="basic" {{ 'selected' if current_user.subscription_plan == 'basic' }}>Basic Plan</option>
                            <option value="premium" {{ 'selected' if current_user.subscription_plan == 'premium' }}>Premium Plan</option>
                            <option value="enterprise" {{ 'selected' if current_user.subscription_plan == 'enterprise' }}>Enterprise Plan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Billing Email</label>
                        <input type="email" name="billing_email" value="{{ current_user.billing_email or current_user.email }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select name="payment_method" class="form-control">
                            <option value="credit_card" {{ 'selected' if current_user.payment_method == 'credit_card' }}>Credit Card</option>
                            <option value="debit_card" {{ 'selected' if current_user.payment_method == 'debit_card' }}>Debit Card</option>
                            <option value="net_banking" {{ 'selected' if current_user.payment_method == 'net_banking' }}>Net Banking</option>
                            <option value="upi" {{ 'selected' if current_user.payment_method == 'upi' }}>UPI</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-outline" onclick="cancelEdit('subscription')">Cancel</button>
                    </div>
                </form>
                <div class="display-content" id="subscriptionDisplay">
                    <div class="info-item" data-field="subscription_plan">
                        <span class="info-label">Current Plan:</span>
                        <span class="info-value plan-badge {{ current_user.subscription_plan }}">
                            {{ current_user.subscription_plan|title }} Plan
                        </span>
                    </div>
                    <div class="info-item" data-field="billing_email">
                        <span class="info-label">Billing Email:</span>
                        <span class="info-value">{{ current_user.billing_email or current_user.email }}</span>
                    </div>
                    <div class="info-item" data-field="payment_method">
                        <span class="info-label">Payment Method:</span>
                        <span class="info-value">{{ current_user.payment_method|title if current_user.payment_method else 'Not set' }}</span>
                    </div>
                    <div class="subscription-actions">
                        <button class="btn btn-sm btn-primary" onclick="upgradePlan()">Upgrade Plan</button>
                        <button class="btn btn-sm btn-outline" onclick="viewBilling()">View Billing</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Settings Card -->
        <div class="profile-card" id="securityCard">
            <div class="card-header">
                <h4>Security Settings</h4>
            </div>
            <div class="card-content">
                <div class="display-content">
                    <div class="info-item">
                        <span class="info-label">Last Login:</span>
                        <span class="info-value">{{ current_user.last_login.strftime('%d-%m-%Y %H:%M') if current_user.last_login else 'Never' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Account Created:</span>
                        <span class="info-value">{{ current_user.created_at.strftime('%d-%m-%Y') if current_user.created_at else 'Unknown' }}</span>
                    </div>
                    <div class="security-actions">
                        <button class="btn btn-sm btn-outline" onclick="changePassword()">Change Password</button>
                        <button class="btn btn-sm btn-outline" onclick="enable2FA()">Enable 2FA</button>
                        <button class="btn btn-sm btn-outline" onclick="viewLoginHistory()">Login History</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preferences Card -->
        <div class="profile-card" id="preferencesCard">
            <div class="card-header">
                <h4>Preferences</h4>
                <button class="btn btn-sm btn-outline" onclick="toggleEdit('preferences')">
                    <span class="edit-icon">✏️</span> Edit
                </button>
            </div>
            <div class="card-content">
                <form id="preferencesForm" class="edit-form" method="POST" action="{{ url_for('msme.update_profile') }}">
                    <input type="hidden" name="form_type" value="preferences">
                    <div class="form-group">
                        <label>Default Warehouse</label>
                        <select name="current_warehouse_id" class="form-control">
                            <option value="">Select default warehouse</option>
                            {% for warehouse in current_user.warehouses %}
                            <option value="{{ warehouse.id }}" {{ 'selected' if current_user.current_warehouse_id == warehouse.id }}>
                                {{ warehouse.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Time Zone</label>
                        <select name="timezone" class="form-control">
                            <option value="Asia/Kolkata" {{ 'selected' if current_user.timezone == 'Asia/Kolkata' }}>India (IST)</option>
                            <option value="UTC" {{ 'selected' if current_user.timezone == 'UTC' }}>UTC</option>
                            <option value="America/New_York" {{ 'selected' if current_user.timezone == 'America/New_York' }}>Eastern Time</option>
                            <option value="Europe/London" {{ 'selected' if current_user.timezone == 'Europe/London' }}>London</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Language</label>
                        <select name="language" class="form-control">
                            <option value="en" {{ 'selected' if current_user.language == 'en' }}>English</option>
                            <option value="hi" {{ 'selected' if current_user.language == 'hi' }}>Hindi</option>
                            <option value="gu" {{ 'selected' if current_user.language == 'gu' }}>Gujarati</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="email_notifications" {{ 'checked' if current_user.email_notifications else '' }}>
                            Receive email notifications
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="sms_notifications" {{ 'checked' if current_user.sms_notifications else '' }}>
                            Receive SMS notifications
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-outline" onclick="cancelEdit('preferences')">Cancel</button>
                    </div>
                </form>
                <div class="display-content" id="preferencesDisplay">
                    <div class="info-item" data-field="current_warehouse_id">
                        <span class="info-label">Default Warehouse:</span>
                        <span class="info-value">{{ current_user.current_warehouse.name if current_user.current_warehouse else 'Not set' }}</span>
                    </div>
                    <div class="info-item" data-field="timezone">
                        <span class="info-label">Time Zone:</span>
                        <span class="info-value">{{ current_user.timezone or 'Asia/Kolkata' }}</span>
                    </div>
                    <div class="info-item" data-field="language">
                        <span class="info-label">Language:</span>
                        <span class="info-value">{{ current_user.language|title if current_user.language else 'English' }}</span>
                    </div>
                    <div class="info-item" data-field="email_notifications">
                        <span class="info-label">Email Notifications:</span>
                        <span class="info-value">{{ 'Enabled' if current_user.email_notifications else 'Disabled' }}</span>
                    </div>
                    <div class="info-item" data-field="sms_notifications">
                        <span class="info-label">SMS Notifications:</span>
                        <span class="info-value">{{ 'Enabled' if current_user.sms_notifications else 'Disabled' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Actions Card -->
        <div class="profile-card" id="accountActionsCard">
            <div class="card-header">
                <h4>Account Actions</h4>
            </div>
            <div class="card-content">
                <div class="display-content">
                    <div class="action-buttons">
                        <button class="btn btn-outline btn-full" onclick="exportData()">
                            📊 Export My Data
                        </button>
                        <button class="btn btn-outline btn-full" onclick="downloadInvoice()">
                            📄 Download Invoices
                        </button>
                        <button class="btn btn-outline btn-full" onclick="contactSupport()">
                            💬 Contact Support
                        </button>
                        <button class="btn btn-outline btn-full" onclick="viewPrivacyPolicy()">
                            🔒 Privacy Policy
                        </button>
                        <button class="btn btn-outline btn-full" onclick="viewTerms()">
                            📋 Terms of Service
                        </button>
                        <button class="btn btn-danger btn-full" onclick="deleteAccount()">
                            🗑️ Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="message-container"></div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/profile.js') }}"></script>
{% endblock %}
